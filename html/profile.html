<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    
    <!-- Bootstrap icon -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
     
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
     
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
 
    <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- link with CSS -->
    <link rel="stylesheet" href="../css/profile.css">
    <link rel="stylesheet" href="../css/common.css">

    <script src="../java_script/loginsignup.js"></script>
    
    <title>Profile</title>

    <style>
        #pfpImg{
          width: 60px;
          height: 75px;
        }
    </style>

</head>
<body>

    <nav class="navbar navbar-expand-md navbar-light bg-light">
        <div class="container-xxl">
          <a href="../html/index.html" class="navbar-brand">
            <span class="fw-bold h1 fs-1 text-secondary">AjiFit</span>
          </a>
          
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
          data-bs-target="#main-nav" aria-controls="main-nav" aria-expanded="false"
          aria-label="Toggle navigation"><span class="navbar-toggler-icon navbar-light"></span></button>
    
          <div class="d-flex flex-column" id="main-nav">
            <div class="justify-content-start  align-items-center pt-4">
              <span class="fs-5 text-warning">Where Flavor Meets Fitness, Naturally.</span>
            </div>
            <div class="collapse navbar-collapse justify-content- align-items-center ms-1" id="main-nav">
              <ul class="navbar-nav">
                <li class="nav-item">
                  <a href="../html/index.html" class="nav-link text-dark">Home</a>
                </li>
                <li class="nav-item">
                  <a href="../html/menu.html" class="nav-link text-dark">Receipe</a>
                </li>
                <li class="nav-item">
                  <a href="../html/exercise.html" class="nav-link text-dark">Exercise</a>
                </li>
                <li class="nav-item">
                  <a href="../html/Tracker.html" class="nav-link text-dark">Calories Tracker</a>
                </li>
                <li class="nav-item">
                  <a href="../html/water.html" class="nav-link text-dark">Water Reminder</a>
                </li>
                <li class="nav-item">
                  <a href="../html/ck.html" class="nav-link text-dark">Community</a>
                </li>
                <li class="nav-item">
                  <a href="../html/faqs.html" class="nav-link text-dark">FAQS</a>
                </li>
                <li class="logged-in nav-item">
                  <a href="./login.html" class="nav-link text-dark" id="logout">Logout</a>
                </li>
              </ul>
            </div>
          </div>
          
          <div class="collapse navbar-collapse justify-content-end align-items-center" id="main-nav">
            <li class="nav-item ms-2 d-none d-md-inline mt-0 pt-0">
              <div>
                <span class="fs-5 text-warning mt-3" id="name1">User_name</span>
                <a href="../html/profile.html"><img src="..." id="pfpImg" class="rounded-circle fs-1 border border-1" alt="..."></a>
              </div>
            </li>
          </div>
        </div>
      </nav>

    <!-- profile -->
    <div id="profile" class="container-lg">

        <!-- image -->
        <div id="profile-left">

            <div id="profile-img">
                <img id="editProfile-btn" class="mt-5 mb-2 mx-4" src="" alt="Avatar">
                <input type="file" accept="image/avatar/*" id="imageUploadInput" style="display: none;">
            </div>

            <div id="profile-name">
                <h6 id="nameBox" class="display-6 fw-bold text-light mt-3 mb-3 mx-4 py-1 px-2">
                    -
                </h6>
            </div>

        </div>

        <!-- text -->
        <div id="profile-right">

            <div id="profile-right-upper">

                <div class="profile-text">

                    <!-- age -->
                    <div class="row">

                        <div class="col-4">
                            <h2 class="fw-bold">Age: </h2>
                        </div>

                        <div class="col-3">
                            <h2 id="ageBox">0</h2>
                        </div>

                        <!-- edit btn -->
                        <div class="col-5 text-end justify-content-end">
                            <button  id="profile-editBtn" class="btn profile-btn">
                                <h3 class="fw-bold">EDIT</h3>
                            </button>
                        </div>

                    </div>

                    <!-- gender -->
                    <div class="row my-3">
                        <div class="col-4">
                            <h2 class="fw-bold">Gender: </h2>
                        </div>

                        <div class="col-3">

                            <h2 id="genderBox">Male/Female</h2>

                            <select id="genderSelectBox" class="form-select visually-hidden" disabled>
                                <option value="malefemale" selected disabled>Male/Female</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>

                        </div>

                        <!-- save btn -->
                        <div class="col-5 text-end justify-content-end">
                            <button  id="profile-saveBtn" class="btn profile-btn" disabled>
                                <h3 class="fw-bold">SAVE</h3>
                            </button>
                        </div>
                    </div>

                    <!-- signature -->
                    <div class="row">

                        <div class="col-4">
                            <h2 class="fw-bold">Membership: </h2>
                        </div>

                        <div class="col-8">
                            <h2 id="memberBox">None</h2>
                        </div>

                    </div>

                </div>

            </div>

            <div id="profile-right-lower" class="mt-5">
                <div class="container">
                    <div class="row">

                        <!-- Height and Weight -->
                        <div class="col-lg-6">
                            <div class="profile-text">
                                <div class="row">
                                    <div class="col-6">
                                        <h2 class="fw-bold">Height: </h2>
                                    </div>
                                    <div class="col-4">
                                        <h2 id="heightBox"></h2>
                                    </div>
                                    <div class="col-1">
                                        <h2>cm</h2>
                                    </div>
                                </div>
            
                                <div class="row">
                                    <div class="col-6">
                                        <h2 class="fw-bold">Weight: </h2>
                                    </div>
                                    <div class="col-4">
                                        <h2 id="weightBox"></h2>
                                    </div>
                                    <div class="col-1">
                                        <h2>kg</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
            
                        <!-- BMI circle -->
                        <div class="col-lg-6">
                            <div id="bmi">
                                <div id="bmi-circle">
                                    <h3>BMI</h3>
                                    <h2 id="bmi-display"></h2>
                                </div>
                                <div class="text-center pt-3">
                                    <h2 id="bmi-result"></h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <!-- library collection -->
    <div class="container-fluid mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div id="library-container" class="mx-3 px-3 py-3">
                    <div id="library-title">
                        <h6 class="display-6">
                            Video Recommended
                        </h6>
                    </div>

                    <!-- video -->
                    <div class="my-3 mx-3">
                        <h3 class="fs-3">Exercise</h3>
                        <div class="row mb-5">
                            
                            <div class="col-sm-2 col-md-4">
                                <div class="embed-responsive embed-responsive-16by9">
                                    <iframe width="560" height="315" src="https://www.youtube.com/embed/eMjyvIQbn9M?si=o-OLiZjP2taO0JtA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                                </div>
                            </div>
                
                            <div class="col-sm-2 col-md-4">
                                <div class="embed-responsive embed-responsive-16by9">
                                    <iframe width="560" height="315" src="https://www.youtube.com/embed/Im5wJLdudDg?si=6WMDjXh49AG5zlQU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                                </div>
                            </div>

                            <div class="col-sm-2 col-md-4">
                                <div class="embed-responsive embed-responsive-16by9">
                                    <iframe width="560" height="315" src="https://www.youtube.com/embed/yWnacRo2VbA?si=-KtEdcDwvjgpleEB" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                                </div>
                            </div>
                        </div>

                        <h3 class="fs-3">Receipe</h3>
                        <div class="row mb-5">
                            
                            <div class="col-sm-2 col-md-4">
                                <div class="embed-responsive embed-responsive-16by9">
                                    <iframe width="560" height="315" src="https://www.youtube.com/embed/skBf_JkYTaI?si=yH6Q23HHiyoSRF4l" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                                </div>
                            </div>
                
                            <div class="col-sm-2 col-md-4">
                                <div class="embed-responsive embed-responsive-16by9">
                                    <iframe width="560" height="315" src="https://www.youtube.com/embed/GZo06HY96ew?si=VpqLSNqhNO_1Rvc-" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                                </div>
                            </div>

                            <div class="col-sm-2 col-md-4">
                                <div class="embed-responsive embed-responsive-16by9">
                                    <iframe width="560" height="315" src="https://www.youtube.com/embed/AYXfaVD5o40?si=G3DTMQbiccCZitem" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- image change dialog -->
    <div id="imgChange" class="container-sm text-center py-5 px-1">
        <div id="imgChange-text">
            <h5 class="fs-1">
                Please select the image you would like to change?
            </h5>
        </div>

        <div class="row mt-5">
            <div class="col-4">
                <img src="../image/avatar/cinderella.webp" class="img-thumbnail" alt="cinderella" id="avatar1">
            </div>
            <div class="col-4">
                <img src="../image/avatar/emma.webp" class="img-thumbnail" alt="emma" id="avatar2">
            </div>
            <div class="col-4">
                <img src="../image/avatar/wu ming.jpg" class="img-thumbnail" alt="wu_ming" id="avatar3">
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-4">
                <img src="../image/avatar/mao li.jpg" class="img-thumbnail" alt="mao_li" id="avatar4">
            </div>
            <div class="col-4">
                <img src="../image/avatar/totoro.webp" class="img-thumbnail" alt="totoro" id="avatar5">
            </div>
            <div class="col-4">
                <img src="../image/avatar/zoro.webp" class="img-thumbnail" alt="zoro" id="avatar6">
            </div>
        </div>

        <div id="imgChange-btn" class="mt-5">
            <button class="btn fs-2" id="changeYes">
                Confirm
            </button>
            <button class="btn fs-2" id="changeNo">
                Cancel
            </button>
        </div>
    </div>


    <footer>
        <div class="container-fluid justify-content-center text-center py-5">
            <div class="row footer-padding">
                <!-- All link -->
                <div class="col-sm-1 col-md-4 col-lg-4">
                    <div id="footer-link">
                        <ul>
                            <li>
                                <h4><a href="../html/index.html">Home</a></h4>
                            </li>
                            <li>
                                <h4><a href="../html/menu.html">Receipe</a></h4>
                            </li>
                            <li>
                                <h4><a href="../html/exercise.html">Exercise</a></h4>
                            </li>
                            <li>
                                <h4><a href="../html/Tracker.html">Calories Tracker</a></h4>
                            </li>
                        </ul>
                    </div>
                </div>
  
                <div class="col-sm-1 col-md-4 col-lg-3">
                    <div id="footer-link">
                        <ul>
                            <li>
                                <h4><a href="../html/water.html">Water Reminder</a></h4>
                            </li>
                            <li>
                                <h4><a href="../html/ck.html">Community</a></h4>
                            </li>
                            <li>
                                <h4><a href="../html/faqs.html">FAQS</a></h4>
                            </li>
                        </ul>
                    </div>
                </div>
  
                <!-- Contact -->
                <div class="col-sm-2 col-md-4 col-lg-5">
                    <h3 class="fs-2 fw-bold">Contact Us</h3>
                    
                    <div class="contact-icon">
                        <a href="https://www.instagram.com/accounts/login"><i class="bi bi-instagram fs-1 me-3"></i></a>
                        <a href="https://web.facebook.com"><i class="bi bi-facebook fs-1 me-3"></i></a>
                        <a href="https://twitter.com/i/flow/login"><i class="bi bi-twitter fs-1 me-3"></i></a>
                    </div>
                    
                    <div class="star mt-3 mb-1">
                        <i class="bi bi-star-fill"></i>
                        <i class="bi bi-star-fill fs-3"></i>
                        <i class="bi bi-star-fill"></i>
                    </div>
  
                    <p>&copy; 2004 - 2024 AjiFit. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/7.14.1-0/firebase.js"></script>

    <script>

        // Add event listeners when the document is fully loaded
        document.addEventListener('DOMContentLoaded', function() {

            //----- FIREBASE -----
            // Initialize Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyBROf8x8AaOQmWY5z1vb0icjOkWoDha6zo",
                authDomain: "useruser-5f5dc.firebaseapp.com",
                databaseURL: "https://useruser-5f5dc-default-rtdb.firebaseio.com",
                projectId: "useruser-5f5dc",
                storageBucket: "useruser-5f5dc.appspot.com",
                messagingSenderId: "294580009654",
                appId: "1:294580009654:web:a0ca0ae3dbaedd53704417",
                measurementId: "G-BZTH9RR80E"
            };

            firebase.initializeApp(firebaseConfig);

            const db = firebase.database();

            //connect to local storage
            const userID = localStorage.getItem('userId');
            
            // Get buttons and elements
            const editProfile = document.getElementById('editProfile-btn');
            const changeImgDialog = document.getElementById('imgChange');
            const editProfileNo = document.getElementById('changeNo'); 
            const editProfileYes = document.getElementById('changeYes');
            const imageUploadInput = document.getElementById('imageUploadInput');

            const editBtn = document.getElementById('profile-editBtn');
            const saveBtn = document.getElementById('profile-saveBtn');

            const nameD = document.getElementById('nameBox');
            const ageD = document.getElementById('ageBox');
            const genderD = document.getElementById('genderBox');
            const memberD = document.getElementById('memberBox');
            const heightD = document.getElementById('heightBox');
            const weightD = document.getElementById('weightBox');

            // retrieve user information
            console.log(userID);
            db.ref(userID).on('value', function(snapshot) { 

                var data = snapshot.val();

                const name1 = data.name;
                const pfpImg = data.profileImg;

                setPfInfo(name1, pfpImg);


                var userName = data.name;
                var userAge = data.age;
                var userGender = data.gender;
                var userMember = data.membership;
                var userHeight = data.height;
                var userWeight = data.weight;
                var userImg = data.profileImg;

                nameD.textContent = userName;
                ageD.textContent = userAge;
                genderD.textContent = userGender;
                memberD.textContent = userMember;
                heightD.textContent = userHeight;
                weightD.textContent = userWeight;

                console.log('imageURL: ', userImg);

                if (userImg === "none") {
                    editProfile.src = '../image/avatar/avatar.jpg';
                } else {
                    editProfile.src = userImg;
                }

                // the bmi calculate
                updateBMI();

                localStorage.setItem('userName', userName);
                console.log('name: ', userName);
            });

            function setPfInfo(name, pfpImg) {
                document.getElementById('name1').textContent = name;
                document.getElementById('pfpImg').src = pfpImg;
            }

            // load profile image if there is image inside
            // profile image change
            editProfile.addEventListener('click', function() {

                document.body.classList.add("stop-scrolling");
                changeImgDialog.style.display = "block";

                // Get all the thumbnail images
                const thumbnails = document.querySelectorAll('.img-thumbnail');

                // Add event listeners for hover effect and click to select
                thumbnails.forEach(thumbnail => {

                    // Click to select
                    thumbnail.addEventListener('click', function() {
                        
                        // Remove 'selected' class from all thumbnails
                        thumbnails.forEach(thumbnail => {
                            thumbnail.classList.remove('selected');
                        });

                        // Add 'selected' class to the clicked thumbnail
                        this.classList.add('selected');
                    });
                });

            });

            // exit profile image change dialog
            editProfileNo.addEventListener('click', function() {

                document.body.classList.remove("stop-scrolling");
                changeImgDialog.style.display = "none";

            });

            // save image
            editProfileYes.addEventListener('click', function() {
                const selectedImage = document.querySelector('.img-thumbnail.selected');
                if (selectedImage) {

                    const filename = selectedImage.src.split('/').pop(); // Get the last part of the URL which is the filename
        
                    // Construct the path with the filename
                    const imagePath = `../image/avatar/${filename}`;

                    // update to firebase
                    db.ref(userID).update ({
                        profileImg: imagePath
                    });

                    editProfile.src = imagePath;
                    console.log('Selected image:', imagePath);

                } else {
                    alert('Please select an image before confirming.');
                }

                document.body.classList.remove("stop-scrolling");
                changeImgDialog.style.display = "none";
                
            });

            // ------BREAK LINE-----
            // edit button
            editBtn.addEventListener('click', function() {
                // Only save button is clickable after clicking on edit button
                editBtn.disabled = true;
                saveBtn.disabled = false;

                // Enable input fields for editing
                enableEditing('heightBox', isNumber);
                enableEditing('weightBox', isNumber);
                enableEditing('ageBox', isNumber); // Include this line to enable editing for the age field

                // If genderBox content is 'Male/Female', show the select box
                if (genderBox.textContent === 'Male/Female') {
                    genderBox.classList.add('visually-hidden'); // Hide the <h2> element
                    genderSelectBox.classList.remove('visually-hidden'); // Show the <select> element
                    genderSelectBox.disabled = false; // Enable the dropdown
                } else {
                    genderBox.classList.remove('visually-hidden');
                    genderSelectBox.classList.add('visually-hidden');
                    genderSelectBox.disabled = true; // Disable the dropdown
                }

                if (ageBox.textContent === '0') {
                    enableEditing('ageBox', isNumber); 
                } else {
                    disableEditing('ageBox');
                }

            });

            // Event listener for gender select box
            const genderSelectBox = document.getElementById('genderSelectBox');
            genderSelectBox.addEventListener('change', function() {
                genderBox.textContent = genderSelectBox.value; // Update genderBox with selected value
                genderBox.classList.remove('visually-hidden'); // Show the <h2> element
                genderSelectBox.classList.add('visually-hidden'); // Hide the <select> element
                genderSelectBox.disabled = true; // Disable the dropdown after selection
            });

            // save button
            saveBtn.addEventListener('click', function() {
                if (checkEmptyFields()) {
                    window.alert('Please fill in all the field.');
                    return;
                }

                editBtn.disabled = false;
                saveBtn.disabled = true;
                genderBox.classList.remove('visually-hidden'); // Show the <h2> element
                genderSelectBox.classList.add('visually-hidden'); // Hide the <select> element
                genderSelectBox.disabled = true; // Disable the dropdown

                // Disable input fields
                disableEditing('ageBox');
                disableEditing('heightBox');
                disableEditing('weightBox');

                // Update BMI display
                updateBMI();

                //Bring to database
                saveValue()
            });

            // open edit field
            function enableEditing(elementId, validationFunction) {
                const field = document.getElementById(elementId);
                field.setAttribute('contenteditable', true);
                field.addEventListener('input', function() {
                    if (!validationFunction(field.textContent.trim())) {
                        //window.alert('Invalid input! Please enter a valid value.');
                        field.textContent = ''; // Clear the invalid input
                    }
                });
            }

            // close edit field
            function disableEditing(elementId) {
                const field = document.getElementById(elementId);
                field.setAttribute('contenteditable', false);
            }

            // validation
            function isNumber(value) {

                if (value.trim() === '') {
                    return true; // Allow empty value
                }

                if ( !( /^\d+$/.test(value) ) ) {
                    window.alert('Invalid input! Please enter a digit.');
                } else if (value.length > 3 ) {
                    window.alert('Invalid input! Please enter properly.');
                } else{
                    return /^\d+$/.test(value);
                }

            }

            function checkEmptyFields() {

                if ( ageBox.textContent.trim() === '' || heightBox.textContent.trim() === '' || weightBox.textContent.trim() === '' ) {
                    return true;
                } else {
                    return false;
                }

            }

            function updateBMI() {
                const displayBMI = document.getElementById('bmi-display');
                const height = parseFloat(heightD.textContent) / 100; // Convert height to meters
                const weight = parseFloat(weightD.textContent); // Weight in kg

                const bmi = weight / (height * height);
                displayBMI.textContent = bmi.toFixed(1);

                const bmiResult = document.getElementById('bmi-result');
                var result = "";

                if (bmi < 18.5) {
                    result = "Underweight";
                } else if (bmi < 24.9){
                    result = "Normal";
                } else if (bmi < 29.9) {
                    result = "Overweight";
                } else if (bmi < 34.9) {
                    result = "Obese";
                } else {
                    result = "Extremely Obese";
                }

                bmiResult.textContent = result;
            }

            // need save to database
            function saveValue() {

                var age = ageD.textContent;
                var gender = genderD.textContent;
                var height = heightD.textContent;
                var weight = weightD.textContent;

                console.log("Age: " + age);
                console.log("Gender: " + gender);
                console.log("Height: " + height);
                console.log("Weight: " + weight);

                db.ref(userID).update({
                    age: age,
                    gender: gender,
                    height: height,
                    weight: weight
                });

            }
        });

    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>
</html>